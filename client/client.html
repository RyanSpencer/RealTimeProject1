<!DOCTYPE html>
<html lang="en">
<head>
    <title>Sweet Draws My Dude</title>
    <script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/babel" >
        "use strict";
        let canvas, ctx, //Main drawing canvas
            sendBufferCanvas, sendBufferCtx, //Canavs used to send information to the server
            serverCanvas, serverCtx; //Canvas used to draw information from the server
        let socket, dragging = false,  //Socket variable and dragging value for drawing
            frames = {}, i = 1, animationId, roomSpace, playerName, points; // Frames object of all frames of animation, i is what instance of frames we are making next, 
                                             // animation id is the value of setinterval so we can cancel it later

        // Taken from stackoverflow
        // http://stackoverflow.com/questions/1484506/random-color-generator-in-javascript
        const randomColor = () => {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
                if (color === '#FF0000') {
                    color = '#';
                    i = 0;
                }
            }         
            return color;
        };

        //Resets the canvas by passing in the 2d reference to the canvas.
        const resetCanvas = (cvs) => {
            cvs.lineWidth = 5;
            cvs.strokeStyle = "black";
            cvs.lineCap = "round";
            cvs.lineJoin = "round";
        };
    
        const joinRoom = (e, room) => {
            const data = {
                room : room,
                name: document.querySelector("#username").value,
            }
            socket.emit('join', data);
            document.querySelector("#waitPage").style.display = "block";
            document.querySelector("#roomPage").style.display = "none";
            roomSpace = room;
        };

        const setup = () => {
            //Establish pointers to the main and server canvas
            canvas = document.querySelector("#canvas");
            ctx = canvas.getContext('2d');
            serverCanvas = document.querySelector("#serverCanvas");
            serverCtx = serverCanvas.getContext('2d');

            resetCanvas(ctx);
            resetCanvas(serverCtx);
            
            //Establish mouse pointers for main canvas
            canvas.onmousedown = doMousedown;
            canvas.onmousemove = doMousemove;
            canvas.onmouseup = doMouseup;
            canvas.onmouseout = doMouseout;
            
            //Setup the buffer canvas
            sendBufferCanvas = document.createElement("canvas");
            sendBufferCanvas.height = canvas.height;
            sendBufferCanvas.width = canvas.width;
            sendBufferCtx = sendBufferCanvas.getContext("2d");    
            
            resetCanvas(sendBufferCtx);
            sendBufferCtx.strokeStyle = "rgba(128, 128, 128, 0.25)";
            
            const room1Handler = (e) => joinRoom(e, "room1");
            const room2Handler = (e) => joinRoom(e, "room2");
            const room3Handler = (e) => joinRoom(e, "room3");
            const room4Handler = (e) => joinRoom(e, "room4");
            
            document.querySelector("#Room1Button").onclick = room1Handler;            
            document.querySelector("#Room2Button").onclick = room2Handler;
            document.querySelector("#Room3Button").onclick = room3Handler;
            document.querySelector("#Room4Button").onclick = room4Handler;
            
        };


     // EVENT CALLBACK FUNCTIONS
        // on down start a line
        const doMousedown = (e) => {
            dragging = true;
            
            ctx.beginPath();
            ctx.moveTo(e.pageX - e.target.offsetLeft, e.pageY - e.target.offsetTop);
            sendBufferCtx.beginPath();
            sendBufferCtx.moveTo(e.pageX - e.target.offsetLeft, e.pageY - e.target.offsetTop);            
        };
        //on move start making lines and stroking
        const doMousemove = (e) =>{
            if (!dragging) return;
        
            ctx.lineTo(e.pageX - e.target.offsetLeft, e.pageY - e.target.offsetTop);
            ctx.stroke();
            sendBufferCtx.lineTo(e.pageX - e.target.offsetLeft, e.pageY - e.target.offsetTop);
            sendBufferCtx.stroke();
        };
        //On mouse up end the current line being drawn
        const doMouseup = (e) => {
            dragging = false;
            ctx.closePath();
            sendBufferCtx.closePath();
        };

        // if the user drags out of the canvas
        const doMouseout = (e) => {
            dragging = false;
            ctx.closePath();
            sendBufferCtx.closePath();
        };
        
        //Update the canvas passed in with whatever data is pushed in
        const updateScreen = (data, cvs) => {
            let image = new Image();
            
            image.onload = () => {
                cvs.save();
                cvs.drawImage(image, data.x, data.y, data.width, data.height);
                cvs.restore();
            };
            
            image.src = data.imgData;
        };
        
        const sendScores = (data, i, guessInfo) => {
            document.querySelector("#waitPage").style.display = "none";
            socket.off("displayGuess");
            if (i < 0) {
                const pointData = {
                    name: playerName, points: 100, drawler: guessInfo.name,
                };
                socket.emit('doneGuessing', pointData);
                return;
            }
            const keys = Object.keys(data);
            if (data[keys[i]].guess === guessInfo.word) {
                const pointData = {
                    name: playerName, points: 100, drawler: guessInfo.name,
                };
                
                socket.emit('doneGuessing', pointData);
            }
            else {
                const pointData = {
                    name: playerName, points: 40, drawler: data[keys[i]].name,
                } 
                socket.emit('doneGuessing', pointData);
            }            
        };

        const init = () => {
            socket = io.connect();
            
            socket.on('connect', () => {
                socket.on('players', (data) => {
                    document.querySelector("#Room1").innerHTML = data.one; 
                    document.querySelector("#Room2").innerHTML = data.two; 
                    document.querySelector("#Room3").innerHTML = data.three;  
                    document.querySelector("#Room4").innerHTML = data.four; 
                    if (data.one >= 8 || data.oneStarted) {
                       document.querySelector("#Room1Button").onclick = null;            
                    }
                    if (data.two >= 8 || data.twoStarted) {
                        document.querySelector("#Room2Button").onclick = null;
                    }
                    if (data.three >= 8 || data.threeStarted) {
                        document.querySelector("#Room3Button").onclick = null;
                    }
                    if (data.four >= 8 || data.fourStarted) {
                        document.querySelector("#Room4Button").onclick = null;
                    }
                });
                setup();
            });
            
            socket.on('displayGif', (data) => {
                console.log(data);
                const keys = Object.keys(data)
                const frameSet = data[keys[0]];
                let k = 1; //K is our animaton loop variable
                //If there is a current animation running, end it
                clearInterval(animationId); 
                
                const displayLoop = () => {
                    //Clear the screen
                    serverCtx.clearRect(0, 0, canvas.width, canvas.height);
                    //Grab the current frame to be drawn
                    const frame = frameSet.gif[k];
                    //Update the server canvas with the current frame
                    updateScreen(frame, serverCtx);
                    //Tick up k so it will draw the next frame next loop
                    k++;
                    //If k has reached the end of the animation reset it
                    if (k > 20) {
                        k = 1;
                    }
                };
                
                //display a frame once every 100ms, resulting in a 2 second animation at 10 fps, decent for viewing simple gifs.
                animationId = setInterval(displayLoop, 100);
                if (frameSet.name === playerName) {
                    document.querySelector("#status").innerHTML = "This is your gif, just sit back and relax";
                    socket.emit('enterGuess', frameSet.word);
                }
                else {
                    console.log(frameSet);
                    document.querySelector("#guess").style.display = "block";
                    document.querySelector("#sendGuess").style.display ="block";
                    document.querySelector("#status").innerHTML = "Give your best guess as to what this is below";
                    
                    document.querySelector("#sendGuess").onclick = () => {
                        if (document.querySelector("#guess").value === frameSet.word) {
                            socket.emit('enterGuess', "");
                        }
                        else {
                            socket.emit('enterGuess', document.querySelector("#guess").value); 
                        }
                        document.querySelector("#guess").style.display = "none";
                        document.querySelector("#sendGuess").style.display ="none";
                    };
                    
                    socket.on('displayGuess', (data) => {
                        document.querySelector("#waitPage").style.display = "block";
                        document.querySelector("#startGame").style.display = "none";
                        document.querySelector("#status").innerHTML = "Now Choose among the following which one is right, If you fail you'll give points to the person who stumped you, otherwise you'll get points for you and the drawler";
                        console.log(frameSet);
                        if (frameSet.name === playerName) {
                            document.querySelector("#waitPage").style.display = "none";
                            document.querySelector("#status").innerHTML = "This is your gif, just sit back and relax";
                        }
                        else if (document.querySelector("#guess").value === frameSet.word) {
                            sendScores(data[playerName], -1, frameSet);
                        }
                        else {
                            console.log(data);
                            const keys = Object.keys(data);
                            switch (keys.length) {
                                case 8:
                                    if (data[keys[7]].name === playerName) {
                                        document.querySelector("#player8").innerHTML = "";
                                    }
                                    else {
                                        document.querySelector("#player8").innerHTML = data[keys[7]].guess;
                                        document.querySelector("#player8").onclick = ()=> { sendScores(data, 7, frameSet);  };
                                    }
                                case 7:
                                    if (data[keys[6]].name === playerName) {
                                       document.querySelector("#player7").innerHTML = "";
                                    }
                                    else {
                                         document.querySelector("#player7").innerHTML = data[keys[6]].guess;
                                        document.querySelector("#player7").onclick = ()=> {sendScores(data, 6, frameSet); };
                                    }
                                case 6:
                                    if (data[keys[5]].name === playerName) {
                                        document.querySelector("#player6").innerHTML = "";
                                    }
                                    else {
                                        document.querySelector("#player6").innerHTML = data[keys[5]].guess;
                                        document.querySelector("#player6").onclick = ()=> {sendScores(data, 5, frameSet); };
                                    }
                                case 5:
                                    if (data[keys[4]].name === playerName) {
                                        document.querySelector("#player5").innerHTML = "";
                                    }
                                    else {
                                        document.querySelector("#player5").innerHTML = data[keys[4]].guess;
                                        document.querySelector("#player5").onclick = ()=> {sendScores(data, 4, frameSet);};
                                    }
                                case 4:
                                    if (data[keys[3]].name === playerName) {
                                        document.querySelector("#player4").innerHTML = "";
                                    }
                                    else {
                                        document.querySelector("#player4").innerHTML = data[keys[3]].guess;
                                        document.querySelector("#player4").onclick = ()=> {sendScores(data, 3, frameSet);};
                                    }
                                case 3:
                                    if (data[keys[2]].name === playerName) {
                                        document.querySelector("#player3").innerHTML = "";
                                    } 
                                    else {
                                        document.querySelector("#player3").innerHTML = data[keys[2]].guess;
                                        document.querySelector("#player3").onclick = ()=>{sendScores(data, 2, frameSet);};
                                    }
                                case 2:
                                    if (data[keys[1]].name === playerName) {
                                       document.querySelector("#player2").innerHTML = "";
                                    }
                                    else {
                                         document.querySelector("#player2").innerHTML = data[keys[1]].guess;
                                        document.querySelector("#player2").onclick = ()=> {sendScores(data, 1, frameSet);};
                                    }
                                case 1:
                                    if (data[keys[0]].name === playerName) {
                                       document.querySelector("#player1").innerHTML = "";
                                    }
                                    else {
                                         document.querySelector("#player1").innerHTML = data[keys[0]].guess;
                                        document.querySelector("#player1").onclick = ()=> {sendScores(data, 0, frameSet);};
                                    }
                                    break;
                                default: 
                                    document.querySelector("#player1").innerHTML = "Error no guesses returned";
                            }
                        }
                        document.querySelector("#guess").value = "";
                    });
                }
                
            });
            
            socket.on('roomWait', (data) => {
                const keys = Object.keys(data);
                 switch (keys.length) {
                     case 8: 
                         document.querySelector("#player8").innerHTML = data[keys[7]].name;
                     case 7:
                         document.querySelector("#player7").innerHTML = data[keys[6]].name;
                     case 6:
                         document.querySelector("#player6").innerHTML = data[keys[5]].name;
                     case 5:
                         document.querySelector("#player5").innerHTML = data[keys[4]].name;
                     case 4:
                         document.querySelector("#player4").innerHTML = data[keys[3]].name;
                     case 3:
                         document.querySelector("#player3").innerHTML = data[keys[2]].name;
                     case 2:
                         document.querySelector("#player2").innerHTML = data[keys[1]].name;
                     case 1:
                         document.querySelector("#player1").innerHTML = data[keys[0]].name;
                         break;
                     default: 
                         document.querySelector("#player1").innerHTML = "Error no players returned";
                 }
                if (keys.length > 3) {
                    document.querySelector("#startGame").style.background = "rgba(155, 52, 78 , 1)"
                    document.querySelector("#startGame").onclick = () => {
                        socket.emit('gameReady');
                    };
                }
            });
            
            socket.on('activateStart', (data) => {
                document.querySelector("#mainPage").style.display = "block";
                document.querySelector("#waitPage").style.display = "none";
                let me = {};
                const keys = Object.keys(data);
                for (let i = 0; i < keys.length; i++) {
                    if (data[keys[i]].name === playerName) {
                        me = data[keys[i]];
                        break;
                    }
                }
                
                document.querySelector("#user").innerHTML = me.name;
                document.querySelector("#word").innerHTML = me.word;
            });
            
            socket.on('updateUsername', (data) => {
                 playerName = data; 
            });
            
            socket.on('pointUpdate', (data) => {
                const keys = Object.keys(data);
                for (let i =0; i< keys.length; i++) {
                    if (data[keys[i]].name === playerName) {
                        document.querySelector("#points").innerHTML = data[keys[i]].points;
                    }
                }
            });
            socket.on('finalScreen', (data) => {
                document.querySelector("#mainPage").style.display = "none";
                document.querySelector("#waitPage").style.display = "block";
                const keys = Object.keys(data);
                switch (keys.length) {
                     case 4:
                         document.querySelector("#player1").innerHTML = data[keys[0]].name + ": " + data[keys[0]].points;
                         document.querySelector("#player2").innerHTML = data[keys[1]].name + ": " + data[keys[1]].points;
                         document.querySelector("#player3").innerHTML = data[keys[2]].name + ": " + data[keys[2]].points;
                         document.querySelector("#player4").innerHTML = data[keys[3]].name + ": " + data[keys[3]].points;
                         document.querySelector("#player5").style.display = "none"
                         document.querySelector("#player6").style.display = "none"
                         document.querySelector("#player7").style.display = "none"
                         document.querySelector("#player8").style.display = "none"
                         break;
                     case 5:
                         document.querySelector("#player1").innerHTML = data[keys[0]].name + ": " + data[keys[0]].points;
                         document.querySelector("#player2").innerHTML = data[keys[1]].name + ": " + data[keys[1]].points;
                         document.querySelector("#player3").innerHTML = data[keys[2]].name + ": " + data[keys[2]].points;
                         document.querySelector("#player4").innerHTML = data[keys[3]].name + ": " + data[keys[3]].points;
                         document.querySelector("#player5").innerHTML = data[keys[4]].name + ": " + data[keys[4]].points;
                         document.querySelector("#player6").style.display = "none"
                         document.querySelector("#player7").style.display = "none"
                         document.querySelector("#player8").style.display = "none"
                         break;  
                      case 6:
                         document.querySelector("#player1").innerHTML = data[keys[0]].name + ": " + data[keys[0]].points;
                         document.querySelector("#player2").innerHTML = data[keys[1]].name + ": " + data[keys[1]].points;
                         document.querySelector("#player3").innerHTML = data[keys[2]].name + ": " + data[keys[2]].points;
                         document.querySelector("#player4").innerHTML = data[keys[3]].name + ": " + data[keys[3]].points;
                         document.querySelector("#player5").innerHTML = data[keys[4]].name + ": " + data[keys[4]].points;
                         document.querySelector("#player6").innerHTML = data[keys[5]].name + ": " + data[keys[5]].points;
                         document.querySelector("#player7").style.display = "none"
                         document.querySelector("#player8").style.display = "none"
                         break;  
                     case 7:
                         document.querySelector("#player1").innerHTML = data[keys[0]].name + ": " + data[keys[0]].points;
                         document.querySelector("#player2").innerHTML = data[keys[1]].name + ": " + data[keys[1]].points;
                         document.querySelector("#player3").innerHTML = data[keys[2]].name + ": " + data[keys[2]].points;
                         document.querySelector("#player4").innerHTML = data[keys[3]].name + ": " + data[keys[3]].points;
                         document.querySelector("#player5").innerHTML = data[keys[4]].name + ": " + data[keys[4]].points;
                         document.querySelector("#player6").innerHTML = data[keys[5]].name + ": " + data[keys[5]].points;
                         document.querySelector("#player7").innerHTML = data[keys[6]].name + ": " + data[keys[6]].points;
                         document.querySelector("#player8").style.display = "none"
                         break;  
                     case 8: 
                         document.querySelector("#player1").innerHTML = data[keys[0]].name + ": " + data[keys[0]].points;
                         document.querySelector("#player2").innerHTML = data[keys[1]].name + ": " + data[keys[1]].points;
                         document.querySelector("#player3").innerHTML = data[keys[2]].name + ": " + data[keys[2]].points;
                         document.querySelector("#player4").innerHTML = data[keys[3]].name + ": " + data[keys[3]].points;
                         document.querySelector("#player5").innerHTML = data[keys[4]].name + ": " + data[keys[4]].points;
                         document.querySelector("#player6").innerHTML = data[keys[5]].name + ": " + data[keys[5]].points;
                         document.querySelector("#player7").innerHTML = data[keys[6]].name + ": " + data[keys[6]].points;
                         document.querySelector("#player8").innerHTML = data[keys[7]].name + ": " + data[keys[7]].points;
                         break;  
                     default: 
                         document.querySelector("#player1").innerHTML = "Error no players returned";
                 }
                
                document.querySelector("#player1").onclick = "";
                document.querySelector("#player2").onclick = "";
                document.querySelector("#player3").onclick = "";
                document.querySelector("#player4").onclick = "";
                document.querySelector("#player5").onclick = "";
                document.querySelector("#player6").onclick = "";
                document.querySelector("#player7").onclick = "";
                document.querySelector("#player8").onclick = "";
                
                const id = setInterval(()=> {
                    socket.emit('endGame');
                    socket.disconnect():
                    clearInterval(id);
                    document.querySelector("#waitPage").style.display = "none";
                    document.querySelector("#roomPage").style.display = "block";
                    init();
                }, 10000);
            });
            
            document.querySelector("#clearButton").onclick = () => {
                    //Clears the screen for the player to start over if they messed up
                    ctx.clearRect(0, 0, canvas.width, canvas.height);  
            };
            
            document.querySelector("#send").onclick = () => {
                //Create the data packet to store in the frames array
                const data = {
                    x: 0,
                    y: 0,
                    height: 480,
                    width: 640,
                    imgData : sendBufferCanvas.toDataURL(),
                };
                //Store it and increase the size
                frames[i] = data;
                i++;
                //If we have all 20 frames send out the information
                if (i > 20) {
                    //Clear the canvases
                    sendBufferCtx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.clearRect(0, 0, canvas.width, canvas.height);  
                    //Send out the gif to be drawn                    
                    socket.emit('drawGif', frames);
                    //Reset frames and size
                    frames = {};
                    i = 0;
                    //Reset the screen count
                    document.querySelector("#frameCount").innerHTML = 1;
                    document.querySelector("#frameTotal").style.display = "none";
                    document.querySelector("#canvas").style.display = "none";
                    document.querySelector("#send").style.display = "none";
                    document.querySelector("#clearButton").style.display = "none";
                    document.querySelector("#serverCanvas").style.display = "block";
                }
                else {
                    //Clear the canvases
                    ctx.clearRect(0, 0, canvas.width, canvas.height);  
                    sendBufferCtx.clearRect(0, 0, canvas.width, canvas.height);
                    //we use the buffer canvas to display the previous frame for helping cohesivie animation
                    updateScreen(data, ctx);
                    //update the frame count on screen
                    document.querySelector("#frameCount").innerHTML = i;
                }
            };
        };
        window.onload = init;
    </script>
    <style>
        canvas {
             background: #ffffff;
             box-shadow: 4px 4px 8px rgba(0,0,0,0.5);
          }
            a {
            width: 300px;
            height: 100px;
            background: rgb(155, 52, 78);
            padding: 15px;
            font-size: 32px;
            text-decoration: none;
            color: white;
            }
        #startGame {
            background:  rgba(155, 52, 78 , 0.5);
        }
        #serverCanvas, #mainPage, #waitPage, #guess, #sendGuess {
            display: none;            
        }
    </style>
</head>
<body>
    <div id="mainPage">
        <p id="status"></p>
        <p>Your Name: <span id="user"> </span></p>
        <p>Your Word: <span id="word"> </span></p>
        <p>Points: <span id="points"></span></p>
        <canvas id="canvas" height="480" width="640"></canvas>
        <canvas id="serverCanvas" height="480" width= "640"></canvas>
        <input id="clearButton" type="button" value="Clear">
        <input id="send" type="button" value="next">
        <p id="frameTotal">Frame <span id="frameCount">1</span>/20</p>
        <input id="guess" type="text">
        <input id="sendGuess" type="button" value="Send Guess">
    </div>
    <div id="roomPage">
        <a id="Room1Button" href="#">Room 1 <span id="Room1">0</span>/8</a>
        <a id="Room2Button" href="#">Room 2 <span id="Room2">0</span>/8</a>
        <a id="Room3Button" href="#">Room 3 <span id="Room3">0</span>/8</a>
        <a id="Room4Button" href="#">Room 4 <span id="Room4">0</span>/8</a>
        <input type="text" name="Username" id="username">
    </div>
    <div id="waitPage">
        <p id="player1"></p>
        <p id="player2"></p>
        <p id="player3"></p>
        <p id="player4"></p>
        <p id="player5"></p>
        <p id="player6"></p>
        <p id="player7"></p>
        <p id="player8"></p>
        <a id="startGame" href="#">Start Game</a>
    </div>
</body>
</html>